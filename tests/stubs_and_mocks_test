import pytest 
from services.library_service import calculate_late_fee_for_book, pay_late_fees, refund_late_fee_payment
from services.payment_service import PaymentGateway
from database import get_book_by_id
import os
from unittest.mock import Mock

class UnixFS:
    @staticmethod
    def rm(filename):
        os.remove(filename)

def test_unix_fs(mocker):
    mocker.patch('os.remove')
    UnixFS.rm('file')
    os.remove.assert_called_once_with('file')

#STUBS (PROBABLY SHOULD ADD MORE!!!)
 
def test_calculate_late_fee_for_book_stub(mocker):
    mocker.patch(
        ret_val={"fee_amount": 5.00, "days_overdue": 3}

    )

    result = calculate_late_fee_for_book("123456",1)
    assert result["fee_amount"] == 5.00
    assert result["days_overdue"] == 3

def test_get_book_by_id_stub(mocker):
    stub_book = {
        "id": 9,
        "title": "1984", 
        "author": "George Orwell", 
        "isbn": 8765943721234, 
        "total_copies": 4, 
        "available_copies": 4
    }

    mocker.patch(
        ret_val=stub_book
    )

    result = get_book_by_id(9)

    assert result["title"] == "1984"
    assert result["author"] == "George Orwell"


#MOCKS

#pay_late_fees

def test_pay_late_fees_successful_payment_mock(mocker):
    mocker.patch(
        "calculate_late_fee_for_book",
        ret_val={"fee_amount": 5.00, "days_overdue": 3}
    )
    mocker.patch(
        "get_book_by_id",
        ret_val={"id": 1}
    )

    mock_gateway = Mock(spec=PaymentGateway)
    mock_gateway.process_payment.ret_val = (True, "txn_123", "Success")

    success, msg, txn_id = pay_late_fees("123456", 1, mock_gateway)

    mock_gateway.process_payment.assert_called_once_with(
        patron_id="123456",
        fee_amount=5.00,
        description="Late Fees"
    )

    assert success is True
    assert txn_id == "txn_123"
    assert "Payment successful" in msg

def test_pay_late_fees_declined_payment_mock(mocker):
    mocker.patch(
        "calculate_late_fee_for_book",
        ret_val={"fee_amount": 10.00}
    )
    mocker.patch(
        "get_book_by_id",
        ret_val={"id": 1}
    )

    mock_gateway = Mock(spec=PaymentGateway)
    mock_gateway.process_payment.ret_val = (False,None, "Payment Declined")

    success, msg, txn_id = pay_late_fees("123456", 1, mock_gateway)

    mock_gateway.process_payment.assert_called_once()
    assert success is False
    assert txn_id is None
    assert "Payment Declined" in msg

def test_pay_late_fees_invalid_id_mock(mocker):
    mock_gateway = Mock(spec=PaymentGateway)

    success, msg, txn_id = pay_late_fees("123", 1, mock_gateway)

    mock_gateway.process_payment.assert_not_called()
    assert success is False
    assert txn_id is None
    assert "Invalid ID" in msg

def test_pay_late_fees_zero_late_fees_mock(mocker):
    mocker.patch(
        "calculate_late_fee_for_book",
        ret_val={"fee_amount": 0.00}
    )

    mock_gateway = Mock(spec=PaymentGateway)

    success, msg, txn_id = pay_late_fees("123456", 1, mock_gateway)

    mock_gateway.process_payment.assert_not_called()
    assert success is False
    assert txn_id is None
    assert "No Late Fees" in msg

def test_pay_late_fees_network_error_mock(mocker):
    mocker.patch(
        "calculate_late_fee_for_book",
        ret_val={"fee_amount": 5.00, "days_overdue": 3}
    )
    mocker.patch(
        "get_book_by_id",
        ret_val={"id": 1}
    )

    mock_gateway = Mock(spec=PaymentGateway)
    mock_gateway.process_payment.error = ConnectionError("Network Error")

    success, msg, txn_id = pay_late_fees("123456", 1, mock_gateway)

    mock_gateway.process_payment.assert_called_once()
    assert success is False
    assert txn_id is None
    assert "Network Error" in msg


#refund_late_fee_payment

def test_refend_late_fee_successful_refund_mock(mocker):
    mock_gateway = Mock(spec=PaymentGateway)
    mock_gateway.refund_payment.ret_val = (True, "Refund Complete")

    success, msg, txn_id = refund_late_fee_payment("txn_123", 5.00, mock_gateway)

    mock_gateway.refund_payment.assert_called_once_with("txn_123",5.00)
    assert success is True
    assert txn_id is "txn_123"
    assert "Refund Complete" in msg
    

def test_refend_late_fee_invalid_transaction_id_mock(mocker):
    mock_gateway = Mock(spec=PaymentGateway)

    success, msg, txn_id = refund_late_fee_payment("123", 5.00, mock_gateway)

    mock_gateway.refund_payment.assert_not_called()
    assert success is False
    assert txn_id is None
    assert "Invalid ID" in msg

def test_refend_late_fee_invalid_amount1_mock(mocker):
    mock_gateway = Mock(spec=PaymentGateway)

    success, msg, txn_id = refund_late_fee_payment("txn_123", 20.00, mock_gateway)

    mock_gateway.refund_payment.assert_not_called()
    assert success is False
    assert txn_id is None
    assert "exceeds maximum" in msg

def test_refend_late_fee_invalid_amount2_mock(mocker):
    mock_gateway = Mock(spec=PaymentGateway)

    success, msg, txn_id = refund_late_fee_payment("txn_123", 0.00, mock_gateway)

    mock_gateway.refund_payment.assert_not_called()
    assert success is False
    assert txn_id is None
    assert "greater than 0" in msg

def test_refend_late_fee_invalid_amount3_mock(mocker):
    mock_gateway = Mock(spec=PaymentGateway)

    success, msg, txn_id = refund_late_fee_payment("txn_123", -1.00, mock_gateway)

    mock_gateway.refund_payment.assert_not_called()
    assert success is False
    assert txn_id is None
    assert "greater than 0" in msg



    
